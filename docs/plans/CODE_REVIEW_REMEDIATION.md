# Code Review Remediation Plan

> **Created:** 2026-01-18
> **Status:** In Progress
> **Approach:** Orchestrator pattern (Review → Implement → Verify → Next)

---

## Executive Summary

This plan addresses tech debt identified in the comprehensive code review. All issues have been validated by explore agents to confirm they are real problems worth fixing.

**Scope:** Big-bang refactor allowed. No production data or releases to worry about.
**Auth:** User IDs generated by client is acceptable (not addressing auth now).

---

## Progress Tracker

| ID | Issue | Status | Notes |
|----|-------|--------|-------|
| H1 | Missing newtypes in domain entities | PENDING | |
| H2 | Error variants missing context IDs | PENDING | |
| H3 | Use case test coverage gaps | PENDING | |
| M1 | Aggregate fields using raw String | PENDING | |
| M3 | Missing ConversationId typed ID | PENDING | |
| M5 | Large ports.rs file | PENDING | Optional |
| L3 | NarrativeOps file size | PENDING | Optional |

**Dismissed (No Action):**
- M2: RegionRelationship public fields (correct per ADR-008)
- M4: Production unwraps in player (all in test/mock code)
- L1: Naming deviations (consistent patterns)
- L2: ChainStatus booleans (orthogonal concepts)
- L4: Swallowed result (intentional)

---

## Task Details

### H1: Missing Newtypes in Domain Entities

**Status:** PENDING

**Problem:**
Domain entities `Region`, `RegionState`, `LocationState` use raw `String` for `name` and `description` fields, while main aggregates (`Character`, `Location`, `World`) use validated newtypes (`CharacterName`, `Description`).

**Files to modify:**
- `crates/domain/src/value_objects/names.rs` - Add `StateName` newtype
- `crates/domain/src/entities/region.rs` - Change `description: String` → `Description`
- `crates/domain/src/entities/region_state.rs` - Change `name`/`description` to newtypes
- `crates/domain/src/entities/location_state.rs` - Change `name`/`description` to newtypes
- Any Neo4j repos that load/save these entities
- Any tests that construct these entities

**Acceptance criteria:**
- [ ] `StateName` newtype created with validation (non-empty, max 100 chars)
- [ ] All 3 entity files use `Description` for description field
- [ ] `RegionState` and `LocationState` use `StateName` for name field
- [ ] All tests pass
- [ ] Clippy clean

---

### H2: Error Variants Missing Context IDs

**Status:** PENDING

**Problem:**
Several error types have "not found" variants without the ID that was searched for, making debugging difficult.

**Error types to fix:**
1. `ExitLocationError` in `movement/exit_location.rs`
   - `PlayerCharacterNotFound` → add `PlayerCharacterId`
   - `LocationNotFound` → add `LocationId`
   - `WorldNotFound` → add `WorldId`
   - `RegionNotFound` → add `RegionId`

2. `JoinWorldError` in `session/join_world.rs`
   - `WorldNotFound` → add `WorldId`

3. `SuggestTimeError` in `time/mod.rs`
   - `WorldNotFound` → add `WorldId`

4. `TimeControlError` in `time/mod.rs`
   - `WorldNotFound` → add `WorldId`

5. `EndConversationError` in `conversation/end.rs`
   - `PlayerCharacterNotFound` → add `PlayerCharacterId`
   - `NpcNotFound` → add `CharacterId`

**Acceptance criteria:**
- [ ] All "not found" error variants include the relevant typed ID
- [ ] Error messages display the ID (via Display trait)
- [ ] All call sites updated to provide the ID
- [ ] All tests pass
- [ ] Clippy clean

---

### H3: Use Case Test Coverage Gaps

**Status:** PENDING

**Problem:**
Only 40% of use cases have unit tests. Critical untested areas include inventory operations, scene resolution, NPC behavior, and event systems.

**Files needing tests (priority order):**

1. **Inventory (6 files)** - Core game mechanics
   - `use_cases/inventory/pickup_item.rs`
   - `use_cases/inventory/drop_item.rs`
   - `use_cases/inventory/equip_item.rs`
   - `use_cases/inventory/unequip_item.rs`
   - `use_cases/inventory/give_item.rs`
   - `use_cases/inventory/place_item.rs`

2. **Scene (1 file)** - Complex condition logic
   - `use_cases/scene/resolve.rs`

3. **NPC (1 file)** - State management
   - `use_cases/npc/mod.rs`

4. **Events (2 files)** - Trigger systems
   - `use_cases/story_events/mod.rs`
   - `use_cases/location_events/mod.rs`

5. **Actantial (1 file)** - Goals/wants
   - `use_cases/actantial/mod.rs`

**Test pattern to follow:**
```rust
#[cfg(test)]
mod tests {
    use super::*;
    use mockall::predicate::*;

    #[tokio::test]
    async fn when_pc_not_found_returns_error() {
        // 1. Setup mocks with specific expectations
        // 2. Create use case with mocked dependencies
        // 3. Execute with test input
        // 4. Assert expected error/result
    }
}
```

**Acceptance criteria:**
- [ ] Each use case file has at least 3 tests (happy path + 2 error cases)
- [ ] Tests use specific mock expectations (not `.any()`)
- [ ] All tests pass
- [ ] Coverage increased to 70%+

---

### M1: Aggregate Fields Using Raw String

**Status:** PENDING

**Problem:**
3 aggregate fields use raw `String` when validated newtypes exist:

1. `Scene.backdrop_override: Option<String>` → should be `Option<AssetPath>`
2. `PlayerCharacter.description: Option<String>` → should be `Option<Description>`
3. `NarrativeEvent.description: String` → should be `Description`

**Note:** `Scene.directorial_notes` and `NarrativeEvent.scene_direction` are intentionally raw `String` (free-form text per ADR-008).

**Files to modify:**
- `crates/domain/src/aggregates/scene.rs`
- `crates/domain/src/aggregates/player_character.rs`
- `crates/domain/src/aggregates/narrative_event.rs`
- Corresponding Neo4j repos
- Tests

**Acceptance criteria:**
- [ ] 3 fields changed to use existing newtypes
- [ ] Constructors/builders updated
- [ ] Neo4j repos handle conversion
- [ ] All tests pass
- [ ] Clippy clean

---

### M3: Missing ConversationId Typed ID

**Status:** PENDING

**Problem:**
Conversation operations use raw `Uuid` instead of typed `ConversationId`, violating the typed ID pattern used everywhere else.

**Files to modify:**
- `crates/domain/src/ids.rs` - Add `ConversationId`
- `crates/engine/src/infrastructure/ports.rs` - Update signatures
- `crates/engine/src/infrastructure/neo4j/character_repo.rs` - Update implementation
- `crates/engine/src/use_cases/conversation/start.rs`
- `crates/engine/src/use_cases/conversation/continue_conversation.rs`
- `crates/engine/src/use_cases/conversation/end.rs`
- `crates/engine/src/use_cases/queues/queue_types.rs`
- `crates/engine/src/use_cases/approval/mod.rs`
- `crates/engine/src/use_cases/player_action/mod.rs`

**Acceptance criteria:**
- [ ] `ConversationId` defined in ids.rs using `define_id!` macro
- [ ] All conversation-related methods use typed ID
- [ ] All tests pass
- [ ] Clippy clean

---

### M5: Large ports.rs File (Optional)

**Status:** PENDING

**Problem:**
`ports.rs` is 1,497 lines with 25 traits. While well-organized, it could be split for better discoverability.

**Proposed structure:**
```
infrastructure/ports/
  mod.rs          # Re-exports
  error.rs        # RepoError, LlmError, ImageGenError, QueueError
  types.rs        # ConnectionInfo, DirectorialContext, etc.
  character.rs    # CharacterRepo
  location.rs     # LocationRepo, RegionStateRepo, LocationStateRepo
  world.rs        # WorldRepo
  player.rs       # PlayerCharacterRepo
  scene.rs        # SceneRepo, ActRepo
  narrative.rs    # NarrativeRepo, LoreRepo
  staging.rs      # StagingRepo
  items.rs        # ItemRepo, ChallengeRepo
  content.rs      # ContentRepo
  observation.rs  # ObservationRepo, InteractionRepo
  assets.rs       # AssetRepo
  flags.rs        # FlagRepo
  external.rs     # LlmPort, ImageGenPort, QueuePort
  testing.rs      # ClockPort, RandomPort
```

**Acceptance criteria:**
- [ ] Each trait in its own file or logical grouping
- [ ] mod.rs re-exports everything
- [ ] All imports updated throughout codebase
- [ ] All tests pass
- [ ] Clippy clean

---

### L3: NarrativeOps File Size (Optional)

**Status:** PENDING

**Problem:**
`narrative_operations.rs` is 914 lines, mixing CRUD delegation with complex trigger evaluation logic.

**Potential extraction:**
- Extract `check_triggers_with_custom_results` into `EvaluateTriggers` use case
- Keep CRUD delegation in `NarrativeOps`

**Acceptance criteria:**
- [ ] Complex trigger logic in separate use case
- [ ] CRUD delegation remains in NarrativeOps
- [ ] All tests pass
- [ ] Clippy clean

---

## Execution Log

### Session 2026-01-18

**Starting orchestrator execution...**

<!-- Progress will be logged below -->

