# P1.5 Phase 4: DM Panel Integration - Progress Document

**Created**: 2025-12-25
**Completed**: 2025-12-25
**Status**: âœ… Complete (Basic Structure - Refinement Pending)
**Parent Plan**: `ACTANTIAL_MODEL_IMPLEMENTATION_PLAN.md`

---

## Context

This document tracks Phase 4 implementation of the Actantial Model System. Phase 4 adds UI components for viewing and editing NPC motivations in the Character Creation/Editing screen.

### Prerequisites (Completed)

- **Phase 1**: Goal Repository - `Neo4jGoalRepository` with CRUD operations
- **Phase 2**: Domain Model - `ActantialContext`, `WantContext`, `ActantialTarget`, value objects
- **Phase 3**: LLM Integration - Motivations in prompt builder, `ActantialContextService`
- **Phase 5**: Goal HTTP Routes - `/api/worlds/{id}/goals`, `/api/goals/{id}`

### Key Files from Previous Phases

| File | Purpose |
|------|---------|
| `domain/src/entities/want.rs` | Want entity with visibility, deflection, tells |
| `domain/src/entities/goal.rs` | Goal entity |
| `domain/src/value_objects/actantial_context.rs` | ActantialContext, WantContext, ActorType |
| `domain/src/value_objects/llm_context.rs` | MotivationsContext for LLM |
| `engine-app/.../actantial_context_service.rs` | ActantialContextService (query only) |
| `engine-adapters/.../goal_repository.rs` | Neo4jGoalRepository |
| `engine-adapters/.../character_repository.rs` | Want and actantial view methods |
| `engine-adapters/.../http/goal_routes.rs` | Goal HTTP routes |

---

## Phase 4 Scope

### Features

1. **Motivations Tab** in Character Editor with:
   - Wants list (create, edit, delete)
   - Want targeting (Character, Item, Goal)
   - Actantial roles (Helpers, Opponents, Sender, Receiver)
   - Secret behavior (deflection, tells) for Hidden/Suspected wants
   - Goals library (view, create, edit world goals)
   - Social stance summary (aggregated allies/enemies)

2. **Real-time Updates** via WebSocket for multi-DM scenarios

3. **LLM Suggestions** for:
   - Want descriptions
   - Deflection behavior
   - Behavioral tells
   - Goal names/descriptions
   - Actantial view reasons

4. **Common Goals** with configurable defaults (env vars + settings)

---

## Implementation Steps

### Step 1: Protocol DTOs and Messages
**Status**: âœ… Complete
**Files**: `crates/protocol/src/messages.rs`

DTOs added:
- `WantVisibilityData`, `ActorTypeData`, `ActantialRoleData`, `WantTargetTypeData`
- `WantData`, `WantTargetData`, `CreateWantData`, `UpdateWantData`
- `ActantialActorData`, `ActantialViewData`
- `NpcActantialContextData`, `SocialViewsData`, `SocialRelationData`
- `GoalData`, `CreateGoalData`, `UpdateGoalData`

ClientMessage variants added:
- `CreateNpcWant`, `UpdateNpcWant`, `DeleteNpcWant`
- `SetWantTarget`, `RemoveWantTarget`
- `AddActantialView`, `RemoveActantialView`
- `GetNpcActantialContext`, `GetWorldGoals`
- `CreateGoal`, `UpdateGoal`, `DeleteGoal`
- `SuggestDeflectionBehavior`, `SuggestBehavioralTells`, `SuggestWantDescription`, `SuggestActantialReason`

ServerMessage variants added:
- `NpcWantCreated`, `NpcWantUpdated`, `NpcWantDeleted`
- `WantTargetSet`, `WantTargetRemoved`
- `ActantialViewAdded`, `ActantialViewRemoved`
- `NpcActantialContextResponse`, `WorldGoalsResponse`
- `GoalCreated`, `GoalUpdated`, `GoalDeleted`
- `DeflectionSuggestions`, `TellsSuggestions`, `WantDescriptionSuggestions`, `ActantialReasonSuggestions`

Placeholder handlers added to:
- `engine-adapters/src/infrastructure/websocket.rs` (returns NOT_IMPLEMENTED errors)
- `player-ui/src/presentation/handlers/session_message_handler.rs` (logging only)

### Step 2: Service Layer Enhancement
**Status**: âœ… Complete
**Files**: `crates/engine-app/src/application/services/actantial_context_service.rs`

Added mutation methods to `ActantialContextService`:
- `create_want()`, `update_want()`, `delete_want()`
- `set_want_target()`, `remove_want_target()`
- `add_actantial_view()`, `remove_actantial_view()`
- `get_world_goals()`, `create_goal()`, `update_goal()`, `delete_goal()`

Request structs added:
- `CreateWantRequest` (description, intensity, priority, visibility, target_id, target_type, deflection_behavior, tells)
- `UpdateWantRequest` (partial updates for all fields)
- `ActorTargetType` enum (Npc, Pc)

### Step 3: HTTP Routes for Wants
**Status**: âœ… Complete
**Files**: `crates/engine-adapters/src/infrastructure/http/want_routes.rs`

Routes implemented:
```
GET    /api/characters/{id}/wants              - List wants
POST   /api/characters/{id}/wants              - Create want
PUT    /api/wants/{want_id}                    - Update want
DELETE /api/wants/{want_id}                    - Delete want
PUT    /api/wants/{want_id}/target             - Set target
DELETE /api/wants/{want_id}/target             - Remove target
GET    /api/characters/{id}/actantial-context  - Full context
POST   /api/characters/{id}/actantial-views    - Add view
DELETE /api/characters/{id}/actantial-views    - Remove view
```

DTOs created: `CreateWantHttpRequest`, `UpdateWantHttpRequest`, `SetWantTargetRequest`, 
`AddActantialViewRequest`, `RemoveActantialViewRequest`, `WantVisibilityDto`, 
`WantResponse`, `WantTargetResponse`, `ActantialContextResponse`, `SocialViewsResponse`

### Step 4: WebSocket Handlers
**Status**: âœ… Complete
**Files**: `crates/engine-adapters/src/infrastructure/websocket.rs`

Handlers for all new ClientMessage variants with:
- DM authorization
- Service calls
- Broadcast to session for real-time updates

**Completed sub-steps:**
- 4a: Added protocol imports and conversion helpers (~150 lines)
- 4b: Implemented 16 CRUD handlers (Create/Update/Delete wants, targets, views, goals, context query)
- 4c: Added 4 suggestion methods to `SuggestionService` (deflection_behavior, behavioral_tells, want_description, actantial_reason)
- 4d: Added new suggestion types to `LLMQueueService` routing

**Note**: Suggestion handlers currently return placeholder responses. LLM integration infrastructure is in place but async queue integration for WebSocket-initiated suggestions requires additional event routing (future iteration).

### Step 5: Player-App Services
**Status**: âœ… Complete
**Files**: `crates/player-app/src/application/services/actantial_service.rs`

Client-side service providing HTTP-based operations for:
- Want CRUD (list, create, update, delete)
- Want targeting (set, remove)
- Actantial context fetching
- Actantial views (add, remove)
- Goal CRUD (list, create, update, delete)

Request types: `CreateWantRequest`, `UpdateWantRequest`, `SetWantTargetRequest`, 
`AddActantialViewRequest`, `RemoveActantialViewRequest`, `CreateGoalRequest`, `UpdateGoalRequest`

Response types: `WantResponse`, `GoalResponse`

Note: Added POST `/api/characters/{id}/actantial-views/remove` endpoint for clients that don't support DELETE with body.

### Step 6: UI Components
**Status**: âœ… Complete (Basic Structure)
**Files**: `crates/player-ui/src/presentation/components/creator/motivations_tab.rs`

Implemented components (in single file):
- `MotivationsTab` - Main tab container with state management
- `WantsSection` - Wants list with add button
- `WantCard` - Want display with expand/collapse for actantial roles
- `ActantialActorBadge` - Badge for displaying helpers/opponents/etc.
- `GoalsSection` - World goals list
- `SocialStanceSection` - Aggregated allies/enemies view
- `WantEditorModal` - Modal for creating/editing wants
- `GoalEditorModal` - Modal for creating goals

Note: Uses placeholder data loading. Production implementation needs:
- HTTP fetch integration via ActantialService
- LLM suggestion button integration
- Target selection (character/item/goal picker)
- Actantial view editor for managing helpers/opponents

### Step 7: Character Form Integration
**Status**: âœ… Complete
**Files**: `crates/player-ui/src/presentation/components/creator/character_form.rs`

Added "Motivations (Actantial Model)" section after Character Sheet section:
- Only shown for existing characters (not new ones being created)
- Renders `MotivationsTab` component with character ID and world ID

### Step 8: Session Message Handler
**Status**: âœ… Complete (Basic Structure)
**Files**: `crates/player-ui/src/presentation/handlers/session_message_handler.rs`

All actantial message types have handlers with logging (lines 1012-1156):
- `NpcWantCreated`, `NpcWantUpdated`, `NpcWantDeleted`
- `WantTargetSet`, `WantTargetRemoved`
- `ActantialViewAdded`, `ActantialViewRemoved`
- `NpcActantialContextResponse`, `WorldGoalsResponse`
- `GoalCreated`, `GoalUpdated`, `GoalDeleted`
- Suggestion responses (deflection, tells, want description, actantial reason)

Note: Actual state updates are deferred to refinement phase (TODO comments in place).

### Step 9: Common Goals Settings
**Status**: âœ… Complete
**Files**: `crates/domain/src/entities/goal.rs`

Added `common_goals` module with:
- `CommonGoalDef` struct (name, description)
- `COMMON_GOALS` constant with 12 default goals:
  - Power, Wealth, Knowledge, Revenge, Justice, Love
  - Freedom, Honor, Survival, Peace, Recognition, Redemption
- `common_goal_names()` helper function

Note: UI integration for "Add Common Goals" button deferred to refinement phase.

### Step 10: Documentation
**Status**: âœ… Complete
**Files**: `docs/systems/character-system.md`, `docs/progress/ACTANTIAL_MODEL_IMPLEMENTATION_PLAN.md`

- Updated `character-system.md` with Motivations Tab features
- Updated implementation plan status to reflect Phase 4 completion

---

## UI Mockups

### Motivations Tab Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Basic Info]  [Appearance]  [Backstory]  [â–¶ Motivations]  [Sheet]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  WANTS                                                        [+ Add Want]  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜… Priority 1                                    ğŸ”’ Hidden [Edit] [X]â”‚   â”‚
â”‚  â”‚ "Atone for the village massacre"                                    â”‚   â”‚
â”‚  â”‚ Target: Redemption (Goal)      Intensity: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ Strong (0.8)  â”‚   â”‚
â”‚  â”‚ â–¼ Actantial Roles / â–¼ Secret Behavior                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  GOALS (World Library)                                       [+ New Goal]  â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  â”‚ Redemption (2) â”‚ Power (3) â”‚ Peace (1) â”‚ [+ Common Goals...]         â”‚   â”‚
â”‚                                                                             â”‚
â”‚  SOCIAL STANCE (Aggregated)                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  â”‚ Allies: Elena, Aldric â”‚ Enemies: Lord Vorn                           â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Progress Tracking

| Step | Status | Notes |
|------|--------|-------|
| 1. Protocol DTOs | âœ… Complete | DTOs + messages + placeholder handlers |
| 2. Service Layer | âœ… Complete | Mutation methods + request types + goal methods |
| 3. HTTP Routes | âœ… Complete | want_routes.rs with full CRUD + actantial views |
| 4. WebSocket Handlers | âœ… Complete | 16 handlers + suggestion methods + queue routing |
| 5. Player-App Services | âœ… Complete | ActantialService with HTTP-based CRUD |
| 6. UI Components | âœ… Complete | Basic MotivationsTab with all sub-components |
| 7. Character Form Integration | âœ… Complete | MotivationsTab section added |
| 8. Session Message Handler | âœ… Complete | All handlers with logging (TODO for state updates) |
| 9. Common Goals Settings | âœ… Complete | 12 default goals in domain layer |
| 10. Documentation | âœ… Complete | character-system.md + plan updated |
| Final Check | âœ… Complete | cargo check + arch-check pass |

---

## Commands

```bash
# Check compilation
nix-shell /home/otto/repos/WrldBldr/Game/shell.nix --run "cd /home/otto/repos/WrldBldr/Game && cargo check --workspace"

# Architecture check
nix-shell /home/otto/repos/WrldBldr/Game/shell.nix --run "cd /home/otto/repos/WrldBldr/Game && cargo xtask arch-check"
```

---

## Key Decisions

1. **Tab Placement**: Motivations is 4th tab (after Backstory)
2. **Goals Editable**: Goals can be edited from Motivations tab
3. **Common Goals**: Hardcoded defaults + env vars + settings
4. **Real-time Updates**: Broadcast changes to all DMs in session
5. **Suggestions**: All text fields support LLM suggestions
6. **No Validation**: Initially no validation rules for wants

---

## Refinement Phase (Complete)

The refinement phase has been completed with the following changes:

### MotivationsTab Refinements âœ…
- [x] Wire up HTTP fetches via ActantialService
- [x] Add LLM suggestion buttons for description, deflection behavior, behavioral tells
- [x] Loading states and error handling
- [x] Implement actantial view editor in WantCard (add/remove helpers, opponents, sender, receiver)
- [x] Fixed RSX parse errors (complex expressions in format strings)
- [x] Fixed borrow checker issues in Dioxus event handlers
- [ ] Implement target selection UI (character/item/goal picker) - **Deferred** (manual ID entry supported)

### Session Message Handler âœ…
- [x] All actantial message types have handlers with logging
- Note: State updates use refresh pattern - component refetches on edit, WebSocket for broadcast

### Common Goals UI âœ…
- [x] Added "+ Common Goals" button to GoalsSection
- [x] Bulk-adds 12 common goals: Power, Wealth, Knowledge, Revenge, Justice, Love, Freedom, Honor, Survival, Peace, Recognition, Redemption

### LLM Suggestion Integration âœ…
- [x] Added actantial suggestion types to SuggestionType enum:
  - `DeflectionBehavior`, `BehavioralTells`, `WantDescription`, `ActantialReason`
- [x] Suggestion buttons in WantEditorModal use existing queue infrastructure
- [x] Engine-side already supports these suggestion types via LLMQueueService

### Key Files Modified in Refinement
- `player-ui/.../services.rs` - Added ActantialService to Services struct and hook
- `player-ui/.../motivations_tab.rs` - Full HTTP integration, suggestion buttons, ActantialViewsEditor
- `player-ui/.../suggestion_button.rs` - Added actantial suggestion types
- `player-app/.../actantial_service.rs` - Fixed priority type (u32)

### ActantialViewsEditor Features (Lines 463-700)
- Inline editor in WantCard for managing actantial roles
- Role selector dropdown (Helper, Opponent, Sender, Receiver)
- Actor type toggle (NPC vs Player Character)
- Character ID input (manual entry - picker deferred)
- Reason input (optional)
- Removable badges for existing views with click-to-remove
- Service calls via ActantialService HTTP endpoints

### Pending (Future Work)
- Target selection UI (picker for characters, items, goals) - currently uses manual ID entry
- Character search/autocomplete in actantial view editor
- Multi-DM real-time state sync via WebSocket (current: refresh on edit)
